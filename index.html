
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸŒ¿ Green Egypt AI â€” ÙƒØ§Ù…Ù„</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Cairo',sans-serif;background:linear-gradient(180deg,#eafaf0,#f6fff9);}
    ::-webkit-scrollbar{width:10px} ::-webkit-scrollbar-thumb{background:#22c55e;border-radius:10px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);padding:16px}
    .muted{color:#6b7280} .small{font-size:.85rem;color:#6b7280}
    .fade{animation:fade .28s ease} @keyframes fade{from{opacity:0}to{opacity:1}}
    .task-done{opacity:.6;text-decoration:line-through}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#16a34a;color:#fff;padding:8px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,.08);display:none}
    .chat-user{background:#dcfce7;text-align:right;padding:8px;border-radius:8px}
    .chat-bot{background:#f3f4f6;text-align:left;padding:8px;border-radius:8px}
    .btn-ghost{background:#f3f4f6;padding:.4rem .6rem;border-radius:.5rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Roboto Mono,monospace}
  </style>
</head>
<body class="p-6">

  <div class="max-w-6xl mx-auto">

    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-extrabold text-green-700 flex items-center gap-3">
          <span style="font-size:1.4rem">ğŸŒ¿</span>
          <span>Green Egypt AI</span>
          <span class="text-sm muted ml-2">Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ â€” Ù…ÙˆÙ‚Ø¹ ÙƒØ§Ù…Ù„</span>
        </h1>
        <p class="small">ÙØ±Ù‚ØŒ Ù…Ù‡Ø§Ù…ØŒ ØªØ­Ø¯ÙŠØ§ØªØŒ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© ÙˆÙ…Ø³Ø§Ø¹Ø¯ Ø¨ÙŠØ¦ÙŠ Ø°ÙƒÙŠ</p>
      </div>

      <div class="flex items-center gap-3">
        <div id="user-badge" class="small muted">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
        <button id="auth-btn" class="bg-green-500 text-white px-4 py-2 rounded">ğŸ“§ ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
        <button id="logout-btn" class="bg-gray-100 px-3 py-2 rounded hidden">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Grid -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left: Chat, Tips, Tasks -->
      <section class="lg:col-span-2 space-y-4">

        <!-- Team Chat -->
        <div class="card">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-green-700 font-bold">ğŸ’¬ Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚</h2>
            <div class="small muted">Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ â€” ÙŠØ±Ø¯ Ø§Ù„Ø¨ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          </div>

          <div id="chat-area" class="h-72 overflow-y-auto p-3 bg-gray-50 rounded mb-3 space-y-2"></div>

          <div class="flex gap-2">
            <input id="chat-msg" class="flex-1 border rounded px-3 py-2" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚..." />
            <button id="send-msg" class="bg-green-600 text-white px-4 py-2 rounded">Ø¥Ø±Ø³Ø§Ù„</button>
            <button id="clear-chat" class="btn-ghost">ğŸ§¹ Ù…Ø³Ø­ Ù…Ø­Ù„ÙŠ</button>
          </div>
        </div>

        <!-- Tips -->
        <div class="card">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-green-700 font-semibold">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©</h3>
            <div class="small muted">ØªØªØ¬Ø¯Ø¯ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† AI</div>
          </div>

          <div id="tip-text" class="text-lg font-medium mb-3 text-center">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

          <div class="flex justify-center gap-2">
            <button id="copy-tip" class="btn-ghost">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†ØµÙŠØ­Ø©</button>
            <button id="add-task-from-tip" class="bg-green-500 text-white px-3 py-2 rounded">â• Ø£Ø¶Ù Ù…Ù‡Ù…Ø©</button>
            <button id="tts-tip" class="btn-ghost">ğŸ”ˆ Ù‚Ø±Ø§Ø¡Ø©</button>
          </div>
        </div>

        <!-- Tasks -->
        <div class="card">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-green-700 font-semibold">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
            <div class="small muted">Ø£Ø¶Ù Ù…Ù‡Ø§Ù…Ù‹Ø§ Ù…Ø´ØªØ±ÙƒØ© Ø£Ùˆ Ø´Ø®ØµÙŠØ©</div>
          </div>

          <div class="flex gap-2 mb-3">
            <input id="task-text" class="flex-1 border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø±Ø¹ ØºØ¯Ø§Ù‹" />
            <input id="task-author" class="w-48 border p-2 rounded" placeholder="Ø§Ø³Ù… Ù…Ù† ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
            <button id="add-task" class="bg-green-600 text-white px-4 py-2 rounded">â• Ø¥Ø¶Ø§ÙØ©</button>
          </div>

          <ul id="tasks-list" class="space-y-2 max-h-56 overflow-y-auto"></ul>
        </div>

      </section>

      <!-- Right: Teams, Leaderboard, Members, Notes -->
      <aside class="space-y-4">

        <!-- Team management -->
        <div class="card">
          <h3 class="text-green-700 font-semibold mb-2">ğŸ‘¥ Ø§Ù„ÙØ±Ù‚ ÙˆØ§Ù„Ø¯Ø¹ÙˆØ§Øª</h3>

          <input id="team-name" class="w-full border p-2 rounded mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ (Ù„Ø¥Ù†Ø´Ø§Ø¡)" />
          <div class="flex gap-2 mb-2">
            <button id="create-team" class="bg-green-600 text-white px-3 py-2 rounded flex-1">â• Ø¥Ù†Ø´Ø§Ø¡ ÙØ±ÙŠÙ‚</button>
            <button id="join-team" class="bg-blue-500 text-white px-3 py-2 rounded flex-1">ğŸ“© Ø§Ù†Ø¶Ù… Ø¹Ø¨Ø± ÙƒÙˆØ¯</button>
          </div>

          <div class="flex gap-2 mb-2">
            <input id="invite-code" class="flex-1 mono border p-2 rounded" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚" readonly />
            <button id="copy-invite" class="btn-ghost">ğŸ“‹ Ù†Ø³Ø®</button>
          </div>
          <div class="small muted">Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙˆØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù….</div>
        </div>

        <!-- Leaderboard -->
        <div class="card">
          <h3 class="text-green-700 font-semibold mb-2">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
          <ul id="leaderboard" class="space-y-2 max-h-40 overflow-y-auto"></ul>
        </div>

        <!-- Members & Notes -->
        <div class="card">
          <h3 class="text-green-700 font-semibold mb-2">ğŸ‘¥ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</h3>
          <ul id="members" class="space-y-1 max-h-40 overflow-y-auto mb-3"></ul>

          <h4 class="text-green-700 font-semibold mb-2">ğŸ““ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ (Ù…Ø³ØªÙ†Ø¯ Ù…Ø´ØªØ±Ùƒ)</h4>
          <textarea id="team-notes" class="w-full border p-2 rounded h-24 mb-2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚..."></textarea>
          <div class="flex gap-2">
            <button id="save-notes" class="bg-green-500 text-white px-3 py-2 rounded flex-1">ğŸ’¾ Ø­ÙØ¸</button>
            <button id="copy-notes" class="btn-ghost">ğŸ“‹ Ù†Ø³Ø®</button>
          </div>
        </div>

      </aside>
    </main>

    <!-- toast -->
    <div id="toast" class="toast">ØªÙ…</div>

    <footer class="mt-6 text-sm text-gray-600 text-center">Â© 2025 Green Egypt AI â€” Ù…Ø´Ø±ÙˆØ¹ Ø¨ÙŠØ¦ÙŠ</footer>
  </div>

  <!-- Firebase compat (Realtime DB + Auth) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    // -------------------------
    // Configs (from you)
    // -------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBH0e1rmosoI4I6nzI8mksu_z6ULwYijMg",
      authDomain: "green-eg-web.firebaseapp.com",
      projectId: "green-eg-web",
      storageBucket: "green-eg-web.firebasestorage.app",
      messagingSenderId: "365854023627",
      appId: "1:365854023627:web:c93168e45f42b618c1e04e",
      measurementId: "G-N6MY7DESZ7",
      databaseURL: "https://green-eg-web-default-rtdb.firebaseio.com"
    };
    const OPENROUTER_KEY = "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";

    // init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM
    const authBtn = document.getElementById('auth-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userBadge = document.getElementById('user-badge');

    const chatArea = document.getElementById('chat-area');
    const chatMsg = document.getElementById('chat-msg');
    const sendMsgBtn = document.getElementById('send-msg');
    const clearChatBtn = document.getElementById('clear-chat');

    const tipText = document.getElementById('tip-text');
    const copyTipBtn = document.getElementById('copy-tip');
    const addFromTipBtn = document.getElementById('add-task-from-tip');
    const ttsTipBtn = document.getElementById('tts-tip');

    const taskText = document.getElementById('task-text');
    const taskAuthor = document.getElementById('task-author');
    const addTaskBtn = document.getElementById('add-task');
    const tasksList = document.getElementById('tasks-list');

    const teamNameInput = document.getElementById('team-name');
    const createTeamBtn = document.getElementById('create-team');
    const joinTeamBtn = document.getElementById('join-team');
    const inviteCodeInput = document.getElementById('invite-code');
    const copyInviteBtn = document.getElementById('copy-invite');

    const leaderboardList = document.getElementById('leaderboard');
    const membersList = document.getElementById('members');
    const notesArea = document.getElementById('team-notes');
    const saveNotesBtn = document.getElementById('save-notes');
    const copyNotesBtn = document.getElementById('copy-notes');

    const toast = document.getElementById('toast');

    // state
    let me = null;           // firebase user object
    let myDisplay = null;    // display name (email prefix)
    let myTeam = null;       // team code
    let tipInterval = null;

    // helpers
    function showToast(msg, time=1800){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display = 'none', time);
    }
    function genCode(){
      return Math.random().toString(36).slice(2,8).toUpperCase();
    }
    function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // -------------------------
    // AUTH (email/password) via prompt for compact UI
    // -------------------------
    authBtn.addEventListener('click', async ()=>{
      const action = prompt("Ø§ÙƒØªØ¨ 'login' Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ 'register' Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨:");
      if(!action) return;
      if(action.toLowerCase() === 'register'){
        const email = prompt('Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:');
        const pass = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„):');
        if(!email||!pass) return alert('Ù…Ø·Ù„ÙˆØ¨ Ø¨ÙŠØ§Ù†Ø§Øª');
        try{
          const cred = await auth.createUserWithEmailAndPassword(email, pass);
          me = cred.user;
          myDisplay = email.split('@')[0];
          // create user record
          await db.ref('users/' + me.uid).set({ email: me.email, display: myDisplay, points: 0, team: null });
          showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }catch(e){ alert(e.message); }
      } else {
        const email = prompt('Ø¨Ø±ÙŠØ¯Ùƒ:');
        const pass = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');
        if(!email||!pass) return alert('Ù…Ø·Ù„ÙˆØ¨ Ø¨ÙŠØ§Ù†Ø§Øª');
        try{
          await auth.signInWithEmailAndPassword(email, pass);
          showToast('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­');
        }catch(e){ alert('Ø®Ø·Ø£: ' + e.message); }
      }
    });

    logoutBtn.addEventListener('click', ()=> auth.signOut());

    // on auth change
    auth.onAuthStateChanged(async user=>{
      if(user){
        me = user;
        myDisplay = (user.email||'user').split('@')[0];
        userBadge.textContent = `ğŸ‘¤ ${myDisplay}`;
        logoutBtn.classList.remove('hidden');
        authBtn.classList.add('hidden');

        // ensure DB user record
        const uSnap = await db.ref('users/' + me.uid).once('value');
        if(!uSnap.exists()) {
          await db.ref('users/' + me.uid).set({ email: me.email, display: myDisplay, points: 0, team: null });
        }
        // set local team if exists
        const u = (await db.ref('users/' + me.uid).once('value')).val();
        if(u && u.team) myTeam = u.team;
        inviteCodeInput.value = myTeam || '';
        // start listeners
        attachListeners();
        // start tip interval
        if(tipInterval) clearInterval(tipInterval);
        getTip(); tipInterval = setInterval(getTip, 10000);
      } else {
        me = null; myDisplay = null; myTeam = null;
        userBadge.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        logoutBtn.classList.add('hidden'); authBtn.classList.remove('hidden');
        inviteCodeInput.value = '';
        clearUI();
        if(tipInterval) { clearInterval(tipInterval); tipInterval = null; }
      }
    });

    // -------------------------
    // Attach listeners : leaderboard, team members, tasks, notes, chat
    // -------------------------
    function attachListeners(){
      // leaderboard (users)
      db.ref('users').on('value', snap=>{
        const users = snap.val() || {};
        const arr = Object.values(users).sort((a,b)=> (b.points||0) - (a.points||0));
        leaderboardList.innerHTML = arr.map(u => `<li class="flex justify-between p-2 bg-white rounded"><span>${escapeHtml(u.display||u.email||'Ù…Ø³ØªØ®Ø¯Ù…')}</span><span class="text-green-700 font-semibold">${u.points||0} Ù†Ù‚Ø·Ø©</span></li>`).join('');
      });

      // team members
      if(myTeam){
        db.ref('teams/' + myTeam + '/members').on('value', snap=>{
          const m = snap.val() || {};
          membersList.innerHTML = Object.values(m).map(n => `<li class="p-2 bg-green-50 rounded">${escapeHtml(n)}</li>`).join('');
        });
        // team notes
        db.ref('teams/' + myTeam + '/notes').on('value', snap=>{
          notesArea.value = snap.val() || '';
        });
        // team tasks
        db.ref('teams/' + myTeam + '/tasks').on('value', snap=>{
          renderTasks(snap.val() || {}, true);
        });
        // team chat
        db.ref('teams/' + myTeam + '/messages').on('value', snap=>{
          renderChat(snap.val() || {});
        });
        // team points (optional show)
        db.ref('teams/' + myTeam + '/points').on('value', snap=>{
          const pts = snap.val() || 0;
          // could show somewhere; we'll show via toast briefly
        });
      } else {
        // personal tasks
        if(!me) return;
        db.ref('personalTasks/' + me.uid).on('value', snap=>{
          renderTasks(snap.val() || {}, false);
        });
      }
      // tasks global fallback
      // also listen for global tasks for non-team use
      db.ref('tasks').on('value', snap => {
        // optional: render global tasks if needed
      });
    }

    // clear UI when logged out
    function clearUI(){
      leaderboardList.innerHTML = '';
      membersList.innerHTML = '';
      tasksList.innerHTML = '';
      notesArea.value = '';
      chatArea.innerHTML = '';
    }

    // -------------------------
    // Teams: create / join / copy invite
    // -------------------------
    createTeamBtn.addEventListener('click', async ()=>{
      if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      const name = (teamNameInput.value || '').trim();
      if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚');
      const code = genCode();
      // create team
      await db.ref('teams/' + code).set({ name, code, members: { [me.uid]: myDisplay }, points: 0, notes: '' });
      // update user
      await db.ref('users/' + me.uid).update({ team: code });
      myTeam = code;
      inviteCodeInput.value = code;
      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© ØªÙ… Ù†Ø³Ø®Ù‡');
      try { await navigator.clipboard.writeText(code); } catch(e){}
      // attach listeners for team
      attachListeners();
    });

    joinTeamBtn.addEventListener('click', async ()=>{
      if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      const code = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©:');
      if(!code) return;
      const snap = await db.ref('teams/' + code).once('value');
      if(!snap.exists()) return alert('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­');
      // add member
      const name = myDisplay || me.email.split('@')[0];
      await db.ref('teams/' + code + '/members/' + me.uid).set(name);
      await db.ref('users/' + me.uid).update({ team: code });
      myTeam = code;
      inviteCodeInput.value = code;
      // add +5 points to team for joining
      await db.ref('teams/' + code + '/points').transaction(v => (v||0) + 5);
      showToast('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆÙ…Ù†Ø­ +5 Ù†Ù‚Ø§Ø· Ù„Ù„ÙØ±ÙŠÙ‚');
      attachListeners();
    });

    copyInviteBtn.addEventListener('click', async ()=>{
      const code = inviteCodeInput.value || myTeam;
      if(!code) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹');
      try{ await navigator.clipboard.writeText(code); showToast('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©'); }catch(e){ showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®'); }
    });

    // -------------------------
    // Tasks: add / complete / delete
    // -------------------------
    addTaskBtn.addEventListener('click', async ()=>{
      if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      const text = (taskText.value||'').trim();
      const by = (taskAuthor.value||'').trim() || myDisplay || me.email.split('@')[0];
      if(!text) return alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø©');
      if(myTeam){
        const tRef = db.ref('teams/' + myTeam + '/tasks').push();
        await tRef.set({ text, by, done: false, createdAt: Date.now() });
      } else {
        const tRef = db.ref('personalTasks/' + me.uid).push();
        await tRef.set({ text, by, done: false, createdAt: Date.now() });
      }
      taskText.value = ''; taskAuthor.value = '';
    });

    function renderTasks(tasksObj, isTeam){
      // tasksObj is { id: {text,by,done,...}, ...}
      tasksList.innerHTML = '';
      const entries = Object.entries(tasksObj);
      entries.sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
      entries.forEach(([id, t])=>{
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
        li.innerHTML = `
          <div>
            <div class="${t.done ? 'task-done' : ''}"><strong>${escapeHtml(t.text)}</strong></div>
            <div class="small muted">âœï¸ ${escapeHtml(t.by||'Ù…Ø¬Ù‡ÙˆÙ„')} â€” ${new Date(t.createdAt||0).toLocaleString()}</div>
          </div>
          <div class="flex gap-2 items-center">
            <input type="checkbox" ${t.done ? 'checked':''} class="task-checkbox" data-id="${id}">
            <button class="btn-ghost delete-task" data-id="${id}">ğŸ—‘ï¸</button>
          </div>
        `;
        tasksList.appendChild(li);
      });
      // attach events
      tasksList.querySelectorAll('.task-checkbox').forEach(ch => {
        ch.onchange = async (e) => {
          const id = ch.dataset.id;
          const path = isTeam ? 'teams/' + myTeam + '/tasks/' + id : 'personalTasks/' + me.uid + '/' + id;
          await db.ref(path + '/done').set(ch.checked);
          if(ch.checked){
            // award points
            // +10 to user and +10 to team (if team)
            await db.ref('users/' + me.uid + '/points').transaction(v => (v||0)+10);
            if(isTeam) await db.ref('teams/' + myTeam + '/points').transaction(v => (v||0)+10);
            showToast('ØªÙ… Ù…Ù†Ø­ Ù†Ù‚Ø§Ø· Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©');
          }
        };
      });
      tasksList.querySelectorAll('.delete-task').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const path = isTeam ? 'teams/' + myTeam + '/tasks/' + id : 'personalTasks/' + me.uid + '/' + id;
          if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) await db.ref(path).remove();
        };
      });
    }

    // -------------------------
    // Team notes save / copy
    // -------------------------
    saveNotesBtn.addEventListener('click', async ()=>{
      if(!myTeam) return alert('Ø§Ù†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ù‹Ø§');
      await db.ref('teams/' + myTeam + '/notes').set(notesArea.value || '');
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
    });
    copyNotesBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(notesArea.value || ''); showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'); }catch(e){ showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'); }
    });

    // -------------------------
    // Chat: send message -> push to DB and call bot
    // -------------------------
    sendMsgBtn.addEventListener('click', async ()=>{
      if(!me) return alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      if(!myTeam) return alert('Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ù‹Ø§');
      const text = (chatMsg.value||'').trim();
      if(!text) return;
      const msgRef = db.ref('teams/' + myTeam + '/messages').push();
      const msgObj = { from: me.uid, name: myDisplay, text, ts: Date.now(), type: 'user' };
      await msgRef.set(msgObj);
      chatMsg.value = '';
      // bot reply: call OpenRouter, then push message
      appendLocalChat(myDisplay, text, 'user'); // immediate local echo
      appendLocalChat('AI', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...', 'bot', true);
      try{
        const reply = await callOpenRouter(text);
        // remove thinking by writing bot reply to DB (will be rendered by listener)
        const botRef = db.ref('teams/' + myTeam + '/messages').push();
        await botRef.set({ from: 'bot', name: 'GreenEgypt-Bot', text: reply, ts: Date.now(), type: 'bot' });
      }catch(e){
        // update thinking message to error locally
        appendLocalChat('AI', 'âš ï¸ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯', 'bot');
      }
    });

    clearChatBtn.addEventListener('click', ()=> { chatArea.innerHTML = ''; showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø´Ø§Øª'); });

    // render chat from DB snapshot
    function renderChat(messagesObj){
      // messagesObj: { id: { from, name, text, ts, type } }
      // We'll render full list but avoid heavy jumps: remember scroll position at bottom check
      const shouldScroll = (chatArea.scrollTop + chatArea.clientHeight) >= (chatArea.scrollHeight - 20);
      chatArea.innerHTML = '';
      const items = Object.entries(messagesObj || {}).sort((a,b)=> a[1].ts - b[1].ts);
      items.forEach(([id, m])=>{
        const div = document.createElement('div');
        div.className = (m.type === 'user' ? 'chat-user' : 'chat-bot') + ' p-2 rounded';
        div.innerHTML = `<div class="small muted">${escapeHtml(m.name)}</div><div class="mt-1">${escapeHtml(m.text)}</div>`;
        chatArea.appendChild(div);
      });
      if(shouldScroll) chatArea.scrollTop = chatArea.scrollHeight;
    }

    // local append for immediate UX (not saved)
    function appendLocalChat(name, text, who, thinking=false){
      const div = document.createElement('div');
      div.className = (who === 'user' ? 'chat-user' : 'chat-bot') + ' p-2 rounded';
      if(thinking) div.dataset.thinking = '1';
      div.innerHTML = `<div class="small muted">${escapeHtml(name)}</div><div class="mt-1">${escapeHtml(text)}</div>`;
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // -------------------------
    // OpenRouter call
    // -------------------------
    async function callOpenRouter(prompt){
      const payload = {
        model: 'gpt-3.5-turbo',
        messages: [
          { role: 'system', content: 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¨ÙŠØ¦ÙŠ ÙˆØ¯Ø§Ø¹Ù… ÙØ±Ù‚ ØªØ·ÙˆØ¹ÙŠØ©â€”Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ù‘Ø· ÙˆÙ…ÙÙŠØ¯.' },
          { role: 'user', content: prompt }
        ],
        max_tokens: 400
      };
      const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + OPENROUTER_KEY },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!data || !data.choices || !data.choices[0]) throw new Error('AI response error');
      return data.choices[0].message.content;
    }

    // -------------------------
    // Tips (periodic)
    // -------------------------
    async function getTip(){
      try{
        const tip = await callOpenRouter('Ø§Ø¹Ø·Ù†ÙŠ Ù†ØµÙŠØ­Ø© Ø¨ÙŠØ¦ÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©) Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ù…ÙˆØ¬Ù‘Ù‡Ø© Ù„ÙØ±Ù‚ Ø¹Ù…Ù„ Ù…Ø¬ØªÙ…Ø¹ÙŠ.');
        tipText.textContent = tip;
      }catch(e){
        tipText.textContent = 'Ø§ØºÙ„Ù‚ Ø§Ù„ØµÙ†Ø¨ÙˆØ± Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù† Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙŠØ§Ù‡.';
      }
    }
    // copy tip
    copyTipBtn.addEventListener('click', async ()=> {
      try{ await navigator.clipboard.writeText(tipText.textContent||''); showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØµÙŠØ­Ø©'); }catch(e){ showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'); }
    });
    addFromTipBtn.addEventListener('click', ()=> { taskText.value = tipText.textContent || ''; });
    ttsTipBtn.addEventListener('click', ()=> {
      const t = tipText.textContent; if(!t) return;
      const ut = new SpeechSynthesisUtterance(t); ut.lang = 'ar-EG'; speechSynthesis.speak(ut);
    });

    // -------------------------
    // Team notes listener (already attached via attachListeners)
    // -------------------------
    // Save notes handled earlier

    // -------------------------
    // Helper: render tasks when no team
    // -------------------------
    // renderTasks handles both team/personal by being called from the right path

    // -------------------------
    // Render initial UI when loaded - get global state if logged out
    // -------------------------
    function init(){
      // show any public tip quickly
      tipText.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØµÙŠØ­Ø©...';
      // If logged in, listeners start from onAuthStateChanged
    }
    init();

    // small utility for getOnce (similar to earlier)
    async function getOnce(dbRef){
      const snap = await dbRef.once('value');
      return snap.exists() ? snap.val() : null;
    }

    // expose showToast to global
    window.showToast = showToast;

    // start
    // When user logs in, tip interval started in onAuthStateChanged
  })();
  </script>
</body>
</html>
